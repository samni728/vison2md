# Docker 构建和部署指南

本项目提供了两种构建模式以适应不同的使用场景。

## 1. API-Only 模式（推荐用于生产环境 API 服务器）

**特点**：

- 不包含 MLX 本地模型依赖
- 构建速度快，镜像体积小
- 仅用来调用外部 API 进行图像/文档处理
- 适用于 Ubuntu 服务器等资源有限的环境

### 构建命令：

```bash
# 使用API-only的Dockerfile构建
DOCKERFILE=Dockerfile.api docker-compose build

# 或者直接使用docker命令
docker build -f Dockerfile.api -t vison2md-vision-ai-webui .
```

### 启动命令：

```bash
DOCKERFILE=Dockerfile.api docker-compose up
```

### 单独启动（无需 compose）：

```bash
docker build -f Dockerfile.api -t vison2md-vision-ai-webui .
docker run -p 8000:8000 -v ./outputs:/app/outputs -v ./uploads:/app/uploads vison2md-vision-ai-webui
```

## 2. 完整模式（包含 MLX 本地推理能力）

**特点**：

- 包含 MLX 模型依赖（体积较大）
- 支持本地模型推理
- 依赖更多系统资源
- 适用于支持本地推理的场景

### 构建命令：

```bash
# 使用完整版本的Dockerfile（默认）
docker-compose build

# 或者明确指定
DOCKERFILE=Dockerfile docker-compose build
```

### 启动命令：

```bash
docker-compose up
```

## 快速一键部署 API 服务器

针对你想要在 Ubuntu 上快速搭建 API 服务器的需求，可以使用以下命令：

```bash
# 1. 使用API-only模式构建
export DOCKERFILE=Dockerfile.api
docker-compose build

# 2. 启动服务
docker-compose up -d

# 3. 检查服务状态
docker-compose ps
```

## 构建优化说明

### API-Only 模式的优势：

- **构建时间快**：只需安装基本依赖，不包括 MLX/torch 等大块依赖
- **镜像小**：只有必要的 FastAPI/web 服务组件
- **启动快**：更少的依赖加载时间
- **资源消耗少**：对服务器硬件要求低

### 技术细节：

- 从 Python 3.11-slim 基础镜像开始
- 只安装 requirements.txt 中的基础 FastAPI 依赖
- 排除 pip 重依赖项如 mlx-vlm、torch 等
- 支持本地 PDF/图片处理和 API 调用模式

当你使用 API 调用模式（base_url + api_key），镜像将调用外部 API 服务而非本地推理，这就完美适合部署在轻量级的 Ubuntu 服务器上。

## 故障排除

### 如果仍然遇到"No module named uvicorn"错误：

1. 确保 requirements.txt 中包含`uvicorn[standard]==0.30.6`
2. 重新构建：`docker-compose build --no-cache`
3. 检查是否还有其他缺失依赖

### 如果只想使用 Docker 运行而不想使用 docker-compose：

```bash
# 构建API-only版本
docker build -f Dockerfile.api -t my-qwen-api .

# 运行单个容器
docker run -d \
  --name qwen-api-server \
  -p 8000:8000 \
  -v $(pwd)/outputs:/app/outputs \
  -v $(pwd)/uploads:/app/uploads \
  my-qwen-api
```

这提供了最大的灵活性来适配你的 Ubuntu 服务器需求！
